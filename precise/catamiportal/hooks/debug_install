#!/bin/bash -x
#==================================================#
# BUILDS THE CATAMIPORTAL SERVER FROM A FRESH 
# INSTALL OF UBUNTU
# -------------------------------------------------#
# USE
#
# sudo ./destroy  # kills any old dbases
# opt 1)
# sudo ./debug_install -u <username> -p <password>
# opt 2)
# sudo ./debug_install -f <credential file>
# opt 3)
# sudo ./debug_install # defaults to looking in ~/.catami.cred
#
# CREDENTIAL FILE
# LINE 1 #Comment
# LINE 2 <username>
# LINE 3 <password>
#
#==================================================#

set -eux

SERVER="http://sandbox.catami.org"
CATAMI_HOME="/home/catami/catamiportal"
MEDIA_ROOT="/home/catami/media"
CREDFILE="~/.catami.cred"

GEOSERVER_WAIT_TIME=240 #secs ... sometimes the sandbox is running slowly and needs time

mkdir -p /home/catami
mkdir -p $CATAMI_HOME
mkdir -p $MEDIA_ROOT

# Copy some files over for geoserver
cp datastore-config.xml $CATAMI_HOME
cp catami-colour-by-depth.sld $CATAMI_HOME
cp local_settings.py $CATAMI_HOME

# make media dirs and setup apache to serve imagery
mkdir -p $MEDIA_ROOT/static

mkdir -p $MEDIA_ROOT/staging
mkdir -p $MEDIA_ROOT/staging/import
mkdir -p $MEDIA_ROOT/staging/archive

mkdir -p $MEDIA_ROOT/catami_live
mkdir -p $MEDIA_ROOT/catami_live/thumbnailimages
mkdir -p $MEDIA_ROOT/catami_live/importedimages

mkdir -p $MEDIA_ROOT/archive

chmod -R 777 $MEDIA_ROOT/staging
chmod -R 777 $MEDIA_ROOT/catami_live

#sed -i "s@$MEDIA_ROOT/staging@MEDIA_ROOT_IMAGES@g" 000-default

#==================================================#
# GRAB THE U_NAME AND PASSWORD
#==================================================#
OPTFIND=1
U_NAME=""
PASSWORD=""

while getopts "u:p:f:" opt; do
    case "$opt" in
    u)
        U_NAME=$OPTARG
        ;;
    p)
        PASSWORD=$OPTARG
        ;;
    f)
        CREDFILE=$OPTARG
        ;;
    esac
done

shift $((OPTFIND-1))

#["$1" = "--"] & shift

if [ -z ${U_NAME} ] # if no user variable must be passed credfile
then

    USER_HOME=$(eval echo ~${SUDO_USER})
    echo "expecting credential file in :: "${USER_HOME}
    i=0
    while read line; do
        param[$i]=$line
        i=`expr $i + 1` 
    done < $CREDFILE

    U_NAME=${param[1]}
    PASSWORD=${param[2]} 
fi

echo "user=$U_NAME, password=$PASSWORD"

#==================================================#
# These should be just the server requirements only 
# !! Exception being scipy for now. pip install not 
# working
#==================================================#
#juju-log "Installing Apache2, Django1.4, postgres, postgis via apt-get"
apt-get install -y python postgresql-9.1 apache2 python-setuptools postgresql-server-dev-9.1 postgresql-9.1-postgis postgis python-scipy binutils libproj-dev gdal-bin git unzip tomcat7 python-opencv libapache2-mod-wsgi

#==================================================#
# SETUP THE POSGIS TEMPLATE FOR POSTGRESQL
#==================================================#
GEOGRAPHY=0
POSTGIS_SQL=postgis.sql

if [ -d "/usr/share/postgresql/9.1/contrib/postgis-1.5" ]
then
    POSTGIS_SQL_PATH=/usr/share/postgresql/9.1/contrib/postgis-1.5
    GEOGRAPHY=1
fi

su postgres -c "createdb -E UTF8 template_postgis" && \
su postgres -c "( createlang -d template_postgis -l | grep plpgsql || createlang -d template_postgis plpgsql )" && \
su postgres -c "psql -d postgres -c \"UPDATE pg_database SET datistemplate='true' WHERE datname='template_postgis';\"" && \
su postgres -c "psql -d template_postgis -f $POSTGIS_SQL_PATH/$POSTGIS_SQL" && \
su postgres -c "psql -d template_postgis -f $POSTGIS_SQL_PATH/spatial_ref_sys.sql" && \
su postgres -c "psql -d template_postgis -c \"GRANT ALL ON geometry_columns TO PUBLIC;\"" && \
su postgres -c "psql -d template_postgis -c \"GRANT ALL ON spatial_ref_sys TO PUBLIC;\""

if [ $GEOGRAPHY -eq 1 ]
then
    su postgres -c "psql -d template_postgis -c \"GRANT ALL ON geography_columns TO PUBLIC;\""
fi

#==================================================#
# SETUP THE DATABASE AND USERS
#==================================================#

su postgres -c "createuser -Rs -A -d -U postgres $U_NAME"
su postgres -c "createdb -E utf8 -O $U_NAME -T template_postgis catamidb"
su postgres -c "psql -c \"ALTER USER $U_NAME WITH PASSWORD '$PASSWORD';\""

sed -i '1a#!! Autogenerated by Jujuj catamiportal charm !!' /etc/postgresql/9.1/main/pg_hba.conf
sed -i "2alocal	        all     $U_NAME                  md5"  /etc/postgresql/9.1/main/pg_hba.conf
sed -i '3ahost		all	all	0.0.0.0/0	md5' /etc/postgresql/9.1/main/pg_hba.conf

sed -i 's/#listen_addresses = /listen_addresses =/' /etc/postgresql/9.1/main/postgresql.conf
sed -i "s/localhost/*/" /etc/postgresql/9.1/main/postgresql.conf

sed -i "s/#port = 5432/port = 5432 #sed gen/" /etc/postgresql/9.1/main/postgresql.conf

#juju-log "Restarting postgres"
/etc/init.d/postgresql restart

#==================================================#
# SETUP THE PYTHON ENVIRONMENT
#==================================================#
#juju-log "Setting up the python environment"
easy_install virtualenv
easy_install virtualenvwrapper
easy_install pip

#export WORKON_HOME=$HOME/.virtualenvs
#source /usr/local/bin/virtualenvwrapper.sh

#rmvirtualenv catami
#mkvirtualenv catami --system-site-packages
#workon catami

#sometimes it can take a little while for the virtualenv to be initiated, just hold up for a second before continuing
#sleep 5s

#== 
# Prepare Apache
#==
cp 000-default /etc/apache2/sites-enabled/

#==================================================#
# PULL THE CATAMI CODE FROM GIT AND INSTALL 
#==================================================#
#juju-log "Pulling CATAMI code from git"

# !! For debugging.  remove existing directories
#rm -r /home/catami

cd /home/catami/catamiportal
git clone https://github.com/catami/catami.git
cd catami

#why? because otherwise the django-nose install fails.  This is a nose bug over 1 year old. Good work guys.
rm -fr /usr/local/man

#juju-log "Pip installing python dependencies" 
pip install -r requirements.txt

#do an upgrade, in case we're installing over a pre installed machine.
pip install --upgrade -r requirements.txt

# local_settings.py
cp ../local_settings.py $CATAMI_HOME/catami/catamiPortal

sed -i "s@STAGING_IMPORT_DIR_TEXT@$MEDIA_ROOT/staging/import@g" $CATAMI_HOME/catami/catamiPortal/local_settings.py
sed -i "s@STAGING_ARCHIVE_DIR_TEXT@$MEDIA_ROOT/staging/archive@g" $CATAMI_HOME/catami/catamiPortal/local_settings.py

#update main django settings for the current server
sed -i "s@WMS_URL =.*@WMS_URL = \"$SERVER:8080/geoserver/wms\" @g" $CATAMI_HOME/catami/catamiPortal/conf/settings/default.py
sed -i "s@IMAGES_ROOT.*@IMAGES_ROOT = \'$MEDIA_ROOT/catami_live/importedimages\'@g" $CATAMI_HOME/catami/catamiPortal/conf/settings/default.py
sed -i "s@THUMBNAILS_STORAGE_ROOT.*@THUMBNAILS_STORAGE_ROOT = \'$MEDIA_ROOT/catami_live/thumbnailimages\'@g" $CATAMI_HOME/catami/catamiPortal/conf/settings/default.py

#juju-log "syncing database"
python manage.py syncdb --noinput

#==================================================#
# SETUP INITIAL MIGRATION FOR SOUTH
#==================================================#
# guardian easy_thumbnails
# ADD NEW APPS TO THIS LIST

#!!! accounts may need to be after accounts in the following list of apps

python manage.py migrate --all

python manage.py syncdb --all

#apps=(guardian accounts Force staging dbadmintool easy_thumbnails userena clustering collection waffle)
#for app in "${apps[@]}"; do
#    echo Doing south migration for ${app}
#    if [ "${app}" != 'clustering' ] ; then
#        echo "reseting app ${app}"
#        ./manage.py reset ${app} --noinput
#    fi

#    python manage.py schemamigration ${app} --initial
#    python manage.py syncdb --noinput
#    python manage.py migrate ${app} 0001 --fake
#    python manage.py migrate ${app} --fake
    #python manage.py migrate ${app}
#done

#python manage.py syncdb --noinput

#python manage.py migrate


#load the waffle fixtures for feature switching
python manage.py loaddata catamidb/fixtures/waffle.json

python manage.py check_permissions

python manage.py collectstatic --noinput

chmod a+rw log/catamiPortal.log
MD5PASSWORD=$(echo $PASSWORD | sha1sum)

#juju-log "set up Django superuser"
su postgres -c "psql -d catamidb -c \"insert into auth_user (id, username, first_name, last_name, email, password, is_staff, is_active, is_superuser,last_login,date_joined) values (-2, '$U_NAME','catami','catami', 'catami@ivec.org', '$MD5PASSWORD',true,true,true,'2012-11-01 14:26:20','2012-11-01 14:26:20')\""

#==================================================#
# DOWNLOAD AND INSTALL SOLR
#==================================================#
#juju-log "pulling and installing solr"
#echo pulling and installing solr
#cd ..
#wget  http://mirrors.gigenet.com/apache/lucene/solr/4.1.0/apache-solr-4.1.0.zip
#unzip apache-solr-4.1.0.zip
#cd apache-solr-4.1.0
#cd example
#nohup java -jar start.jar &

#echo installing search
#cd ../../catami
#sh src/install_search.sh

#echo rebuilding index
#python manage.py rebuild_index --noinput

#echo updating index
#python manage.py update_index

#==================================================#
# SET UP APACHE PORT REVERSE PROXY
#==================================================#
a2enmod proxy_http
a2enmod rewrite

echo "catamiportal install complete"

#==================================================#
# ADD CRON JOB TO DO A HOURLY BACKUP.
#==================================================#


#==================================================#
# add the current directory and the parent directory to PYTHONPATH
# sets DJANGO_SETTINGS_MODULE
#==================================================#
export DJANGO_SETTINGS_MODULE=catamiPortal.settings

echo "Creating cron job for backup"
BAKSCRIPT=/etc/cron.hourly/catamiPortalBak.py
sudo touch $BAKSCRIPT
sudo echo \#! /usr/bin/env python >> $BAKSCRIPT
sudo echo import os >> $BAKSCRIPT
sudo echo import sys >> $BAKSCRIPT
sudo echo os.chdir\(\'$CATAMI_HOME/catami\'\) >> $BAKSCRIPT
sudo echo sys.path.append\(\'$CATAMI_HOME/catami/dbadmintool\'\) >> $BAKSCRIPT
sudo echo sys.path.append\(\'$CATAMI_HOME/catami\'\) >> $BAKSCRIPT
sudo echo os.environ\[\'DJANGO_SETTINGS_MODULE\' \] = \"catamiPortal.settings\" >> $BAKSCRIPT
sudo echo import dbadmintool.administratorbot as administratorbot >> $BAKSCRIPT
sudo echo bender = administratorbot.Robot\(\) >> $BAKSCRIPT
sudo echo bender.make_local_backup\(directory=\'${CATAMI_HOME}/catami/dbadmintool/backup/\'\) >> ${BAKSCRIPT}

chmod +x $BAKSCRIPT

#==================================================#
# ADD CRON SCRIPT TO LOG DATABASE DATA
#==================================================#
echo "Creating cron job for database logging"
LOGSCRIPT=/etc/cron.hourly/catamiPortalLog.py
sudo touch $LOGSCRIPT
sudo echo \#! /usr/bin/env python >> $LOGSCRIPT
sudo echo import os >> $LOGSCRIPT
sudo echo import sys >> $LOGSCRIPT
sudo echo os.chdir\(\'$CATAMI_HOME/catami\'\) >> $LOGSCRIPT
sudo echo sys.path.append\(\'$CATAMI_HOME/catami/dbadmintool\'\) >> $LOGSCRIPT
sudo echo sys.path.append\(\'$CATAMI_HOME/catami\'\) >> $LOGSCRIPT
sudo echo os.environ\[\'DJANGO_SETTINGS_MODULE\' \] = \"catamiPortal.settings\" >> $LOGSCRIPT
sudo echo import dbadmintool.administratorbot as administratorbot >> $LOGSCRIPT
sudo echo dbReportBot = administratorbot.ReportTools\(\) >> $LOGSCRIPT
sudo echo dbReportBot.collect_stats\(\) >> ${LOGSCRIPT}

chmod +x $LOGSCRIPT

#juju-log "catamiportal install complete"

echo "... Done"

#==================================================#
# SETUP GEOSERVER
#==================================================#

if [ -a geoserver-2.2.4-war.zip ]
then
    echo 'geoserver-2.2.4.zip found, skipping download'
else
    echo 'Downloading geoserver'
    wget http://downloads.sourceforge.net/project/geoserver/GeoServer/2.2.4/geoserver-2.2.4-war.zip
fi

unzip geoserver-2.2.4-war.zip
sudo cp geoserver.war /var/lib/tomcat7/webapps/

#Geoserver takes tome time to finish installing.  TODO: find someway of monitoring
sleep $GEOSERVER_WAIT_TIME

cd $CATAMI_HOME

# sed replace the username and password in datastore-config.xml
sed -i "s/pocock/$U_NAME/g" datastore-config.xml
sed -i "s/qwer789ASDF456zxcv123/$PASSWORD/g" datastore-config.xml

echo 'setting up geoserver'

#need to create a view on postgres so that geoserver can access measurements
su postgres -c "psql -d catamidb -c \"CREATE VIEW public.measurements_view AS SELECT p.id, max(CASE WHEN (m.measurement_type_id = 1) THEN m.value ELSE NULL::double precision END) AS temperature, max(CASE WHEN (m.measurement_type_id = 2) THEN m.value ELSE NULL::double precision END) AS salinity, max(CASE WHEN (m.measurement_type_id = 3) THEN m.value ELSE NULL::double precision END) AS pitch, max(CASE WHEN (m.measurement_type_id = 4) THEN m.value ELSE NULL::double precision END) AS roll, max(CASE WHEN (m.measurement_type_id = 5) THEN m.value ELSE NULL::double precision END) AS yaw, max(CASE WHEN (m.measurement_type_id = 6) THEN m.value ELSE NULL::double precision END) AS altitude FROM catamidb_scientificposemeasurement m, catamidb_pose p WHERE (m.pose_id = p.id) GROUP BY p.id;\""
su postgres -c "psql -d catamidb -c \"GRANT ALL ON public.measurements_view TO PUBLIC;\""

# do this as default admin admin:geoserver

curl -u admin:geoserver -v -XPOST -H 'Content-type: text/xml' \
   -d '<workspace><name>catami</name></workspace>' \
   http://localhost:8080/geoserver/rest/workspaces ;

curl -u admin:geoserver -XPOST -T datastore-config.xml -H 'Content-type: text/xml' \
  http://localhost:8080/geoserver/rest/workspaces/catami/datastores ;

#for catamidb images
curl -u admin:geoserver -XPOST -H 'Content-type: text/xml' \
    -d "<featureType><name>catamidb_images</name><metadata><entry key=\"JDBC_VIRTUAL_TABLE\"><virtualTable><name>catamidb_images</name><sql>SELECT public.catamidb_pose.deployment_id,public.catamidb_pose.position,public.catamidb_pose.depth,public.catamidb_image.id,public.catamidb_image.web_location,public.catamidb_image.archive_location,public.catamidb_deployment.start_time_stamp,public.catamidb_deployment.end_time_stamp,public.measurements_view.temperature,public.measurements_view.salinity,public.measurements_view.pitch,public.measurements_view.roll,public.measurements_view.yaw,public.measurements_view.altitude FROM public.catamidb_pose,public.catamidb_image,public.measurements_view, public.catamidb_deployment WHERE public.catamidb_pose.id=public.catamidb_image.id and public.catamidb_pose.id=public.measurements_view.id and public.catamidb_pose.deployment_id=public.catamidb_deployment.id</sql><keyColumn>id</keyColumn><geometry><name>position</name><type>Point</type><srid>4326</srid></geometry></virtualTable></entry></metadata></featureType>" \
    http://localhost:8080/geoserver/rest/workspaces/catami/datastores/catamidb/featuretypes ;

#for collection images
curl -u admin:geoserver -XPOST -H 'Content-type: text/xml' \
    -d "<featureType><name>collection_images</name><metadata><entry key=\"JDBC_VIRTUAL_TABLE\"><virtualTable><name>collection_images</name><sql>SELECT public.catamidb_image.id, public.collection_collection_images.collection_id, public.catamidb_pose.deployment_id, public.catamidb_pose.position, public.catamidb_pose.depth, public.catamidb_image.web_location, public.catamidb_image.archive_location FROM public.collection_collection_images,public.catamidb_pose,public.catamidb_image WHERE public.catamidb_pose.id = public.catamidb_image.pose_id AND public.collection_collection_images.image_id=public.catamidb_image.id</sql><keyColumn>id</keyColumn><geometry><name>position</name><type>Point</type><srid>4326</srid></geometry></virtualTable></entry></metadata></featureType>" \
    http://localhost:8080/geoserver/rest/workspaces/catami/datastores/catamidb/featuretypes ;


#if doing this on an existing server with same style name that has been deleted from geoserver,
#need to actually delete the styles/catami-colour-by-depth.sld file first - geoserver does not delete it for some reason

curl -u admin:geoserver -XPOST -H 'Content-type: application/vnd.ogc.sld+xml' \
  -d @catami-colour-by-depth.sld http://localhost:8080/geoserver/rest/styles ;

curl -u admin:geoserver -XPUT -H 'Content-type: text/xml' \
  -d '<layer><defaultStyle><name>catami-colour-by-depth</name></defaultStyle><enabled>true</enabled></layer>' \
  http://localhost:8080/geoserver/rest/layers/catami:catamidb_images ;

curl -u admin:geoserver -XPUT -H 'Content-type: text/xml' \
  -d '<layer><defaultStyle><name>catami-colour-by-depth</name></defaultStyle><enabled>true</enabled></layer>' \
  http://localhost:8080/geoserver/rest/layers/catami:collection_images ;


#TODO change username and password for admin
# look in /var/lib/tomcat7/webapps/geoserver/data/security

sed -i "s/admin=geoserver/$U_NAME=$PASSWORD/g" /var/lib/tomcat7/webapps/geoserver/data/security/users.properties.old
sudo mv /var/lib/tomcat7/webapps/geoserver/data/security/users.properties.old /var/lib/tomcat7/webapps/geoserver/data/security/users.properties

  
#install geoserver templates for in-view popups
sed -i "s@MEDIA_HOST@$SERVER/media/catami_live/importedimages/@g" $CATAMI_HOME/catami/webinterface/templates/geoserver/content.ftl
sudo mkdir /var/lib/tomcat7/webapps/geoserver/data/templates/
sudo cp $CATAMI_HOME/catami/webinterface/templates/geoserver/header.ftl /var/lib/tomcat7/webapps/geoserver/data/templates/
sudo cp $CATAMI_HOME/catami/webinterface/templates/geoserver/footer.ftl /var/lib/tomcat7/webapps/geoserver/data/templates/
sudo cp $CATAMI_HOME/catami/webinterface/templates/geoserver/content.ftl /var/lib/tomcat7/webapps/geoserver/data/workspaces/catami/catamidb/catamidb_images/
sudo cp $CATAMI_HOME/catami/webinterface/templates/geoserver/content.ftl /var/lib/tomcat7/webapps/geoserver/data/workspaces/catami/catamidb/collection_images/

echo 'Restarting tomcat'
sudo service tomcat7 restart

