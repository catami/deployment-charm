#!/bin/bash -x

CRON_LOG_FILE="/etc/cron.hourly/catamiPortalLog.py"
CRON_BAK_FILE="/etc/cron.hourly/catamiPortalBak.py"
CATAMI_DIR="/home/catami"

service tomcat7 stop
#sudo pip uninstall django-guardian easy-thumbnails

#==================================================#
# DESTORY THE DATABASE, TEST DATABASE AND SUPERUSER
#==================================================#
echo "Destroying database, test database and superuser" 
su postgres -c "dropdb catamidb"
su postgres -c "dropdb test_catamidb"
su postgres -c "dropuser pocock"

apps=(guardian Force staging dbadmintool easy_thumbnails userena clustering collection features)
for app in "${apps[@]}"; do
    su postgres -c "dropdb ${app}"
done

#==================================================#
# REMOVE THE LOG FILES
#==================================================#
echo "Removing log files"

if [ -f $CRON_BAK_FILE ]; then
    rm $CRON_BAK_FILE
fi

if [ -f $CRON_LOG_FILE ]; then
    rm $CRON_LOG_FILE
fi

#==================================================#
# REMOVE ANY OLD INSTALL DIRECTORIES
#==================================================#
echo "removing "$CATAMI_DIR

if [ -d $CATAMI_DIR ]; then
    rm -r $CATAMI_DIR
fi

#==================================================#
# REMOVE TOMCAT AND GEOSERVER
#==================================================#
sudo service tomcat7 stop
sudo rm -r /var/lib/tomcat7/webapps/geoserver
#sudo apt-get remove --purge tomcat
sudo service tomcat7 start

#bug fix -- not sure why need this twice
su postgres -c "dropuser pocock"

service tomcat7 start
